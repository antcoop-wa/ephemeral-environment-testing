name: Create Render Preview Service

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Verify jq is installed
        run: jq --version
        
      - name: Debug network environment
        run: |
          echo "--- proxy env vars ---"
          env | grep -i proxy || true
          echo "--- curl version ---"
          curl --version
        
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Static Site Service
        run: |
          set -e
          
          # Helper function to parse curl response with status
          parse_response() {
            local raw="$1"
            echo "$raw" | awk -F"::HTTP_STATUS::" '{print $1}'
          }
          
          get_status() {
            local raw="$1"
            echo "$raw" | awk -F"::HTTP_STATUS::" '{print $2}'
          }
          
          # Helper to make curl requests
          curl_api() {
            local method="$1"
            local url="$2"
            local data="$3"
            curl -sS --noproxy api.render.com --retry 3 --retry-delay 2 \
              --request "$method" \
              --url "$url" \
              --header "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
              --header "Accept: application/json" \
              --header "Content-Type: application/json" \
              ${data:+--data "$data"} \
              -w "::HTTP_STATUS::%{http_code}"
          }
          
          # Setup
          echo "Creating static site service for PR ${{ github.event.pull_request.number }}"
          SERVICE_NAME="wa-test-pr-${{ github.event.pull_request.number }}-static"
          ENVIRONMENT_ID="${{ vars.RENDER_ENV_ID }}"
          
          # Validate config
          [ -n "$ENVIRONMENT_ID" ] || { echo "ERROR: RENDER_ENV_ID is empty"; exit 1; }
          [ -n "${{ secrets.RENDER_API_KEY }}" ] || { echo "ERROR: RENDER_API_KEY is empty"; exit 1; }
          
          echo "Environment ID: $ENVIRONMENT_ID"
          echo "Service Name: $SERVICE_NAME"
          echo "Repo: ${{ github.event.pull_request.head.repo.clone_url }}"
          echo "Branch: ${{ github.head_ref }}"
          
          # Check if service exists
          echo "Checking for existing service..."
          LIST_RAW=$(curl_api GET "https://api.render.com/v1/services")
          LIST_BODY=$(parse_response "$LIST_RAW")
          LIST_STATUS=$(get_status "$LIST_RAW")
          
          echo "List status: $LIST_STATUS"
          SERVICE_ID=$(echo "$LIST_BODY" | jq -r ".[] | select(.service.name == \"$SERVICE_NAME\") | .service.id" 2>/dev/null | head -1)
          SERVICE_URL=$(echo "$LIST_BODY" | jq -r ".[] | select(.service.name == \"$SERVICE_NAME\") | .service.serviceDetails.url" 2>/dev/null | head -1)
          
          # Create or update service
          if [ -n "$SERVICE_ID" ] && [ "$SERVICE_ID" != "null" ]; then
            echo "Service exists (ID: $SERVICE_ID). Updating..."
            UPDATE_DATA='{"branch": "${{ github.head_ref }}", "autoDeploy": "yes"}'
            SERVICE_RAW=$(curl_api PATCH "https://api.render.com/v1/services/$SERVICE_ID" "$UPDATE_DATA")
            OP="update"
          else
            echo "Service not found. Creating new service..."
            CREATE_DATA='{
              "type": "static_site",
              "name": "'$SERVICE_NAME'",
              "repo": "${{ github.event.pull_request.head.repo.clone_url }}",
              "branch": "${{ github.head_ref }}",
              "autoDeploy": "yes",
              "environmentId": "'$ENVIRONMENT_ID'",
              "ownerId": "${{ secrets.RENDER_OWNER_ID }}",
              "serviceDetails": {
                "buildCommand": "npm install; npm run build",
                "publishPath": "./dist"
              }
            }'
            SERVICE_RAW=$(curl_api POST "https://api.render.com/v1/services" "$CREATE_DATA")
            OP="create"
          fi
          
          # Parse response
          SERVICE_BODY=$(parse_response "$SERVICE_RAW")
          SERVICE_STATUS=$(get_status "$SERVICE_RAW")
          echo "Service $OP status: $SERVICE_STATUS"
          echo "Response: $SERVICE_BODY"
          
          SERVICE_ID=$(echo "$SERVICE_BODY" | jq -r '.service.id' 2>/dev/null)
          SERVICE_URL=$(echo "$SERVICE_BODY" | jq -r '.service.serviceDetails.url' 2>/dev/null)
          
          [ -n "$SERVICE_ID" ] && [ "$SERVICE_ID" != "null" ] || { echo "ERROR: Failed to get service ID"; exit 1; }
          
          echo "Service ID: $SERVICE_ID"
          echo "Service URL: $SERVICE_URL"
          echo "$SERVICE_ID" > service-id.txt
          echo "$SERVICE_URL" > service-url.txt
          echo "SERVICE_ID=$SERVICE_ID" >> $GITHUB_OUTPUT
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT

      - name: Upload service ID artifact
        uses: actions/upload-artifact@v4
        with:
          name: service-id
          path: service-id.txt

      - name: Upload service URL artifact
        uses: actions/upload-artifact@v4
        with:
          name: service-url
          path: service-url.txt
          
      - name: Post URL to PR review comment
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let serviceUrl = 'URL not available';
            try {
              if (fs.existsSync('service-url.txt')) {
                serviceUrl = fs.readFileSync('service-url.txt', 'utf8').trim();
              }
            } catch (e) {
              console.log('Could not read service-url.txt');
            }
            
            // Post as review comment (works on forks)
            github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              body: `ðŸš€ Preview environment deployed!\n\n**Service URL:** ${serviceUrl}\n\nThis preview will be cleaned up when the PR is closed.`,
              event: 'COMMENT'
            }).catch(err => {
              console.log('Review comment failed, trying simple comment...');
              // Fallback: try regular comment
              return github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `ðŸš€ Preview environment deployed!\n\n**Service URL:** ${serviceUrl}\n\nThis preview will be cleaned up when the PR is closed.`
              });
            });
