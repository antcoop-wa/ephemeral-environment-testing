name: Create Render Preview Environment

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Environment
        run: |
          echo "Creating ephemeral environment for PR ${{ github.event.pull_request.number }}"
          ENV_RESPONSE=$(curl --request POST \
            --url "https://api.render.com/v1/projects/${{ secrets.RENDER_PROJECT_ID }}/environments" \
            --header "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            --header "Content-Type: application/json" \
            --data '{
              "name": "wa-test-pr-${{ github.event.pull_request.number }}-env",
              "description": "Ephemeral environment for PR #${{ github.event.pull_request.number }}"
            }')
          ENVIRONMENT_ID=$(echo "$ENV_RESPONSE" | jq -r '.id')
          echo "Environment ID: $ENVIRONMENT_ID"
          echo "$ENVIRONMENT_ID" > environment-id.txt

      - name: Create Static Site Service in Environment
        run: |
          echo "Creating static site service in environment for PR ${{ github.event.pull_request.number }}"
          ENVIRONMENT_ID=$(cat environment-id.txt)
          SERVICE_RESPONSE=$(curl --request POST \
            --url "https://api.render.com/v1/environments/$ENVIRONMENT_ID/services" \
            --header "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            --header "Content-Type: application/json" \
            --data '{
              "type": "static_site",
              "name": "wa-test-pr-${{ github.event.pull_request.number }}-static",
              "repo": "${{ github.event.pull_request.head.repo.clone_url }}",
              "branch": "${{ github.head_ref }}",
              "publishDirectory": "./dist",
              "autoDeploy": false
            }')
          SERVICE_ID=$(echo "$SERVICE_RESPONSE" | jq -r '.id')
          echo "Service ID: $SERVICE_ID"
          echo "$SERVICE_ID" > service-id.txt

      - name: Upload environment ID artifact
        uses: actions/upload-artifact@v4
        with:
          name: environment-id
          path: environment-id.txt

      - name: Upload service ID artifact
        uses: actions/upload-artifact@v4
        with:
          name: service-id
          path: service-id.txt
          
      - name: Post URL to PR comment (placeholder)
        # Add a step to comment the preview URL back to the GitHub Pull Request
        run: echo "Preview environment is available at some-url-for-pr-${{ github.event.pull_request.number }}"