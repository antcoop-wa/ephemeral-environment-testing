name: Create Render Preview Service

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Verify jq is installed
        run: jq --version
        
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Static Site Service
        run: |
          echo "Creating static site service for PR ${{ github.event.pull_request.number }}"
          SERVICE_NAME="wa-test-pr-${{ github.event.pull_request.number }}-static"
          ENVIRONMENT_ID="${{ secrets.RENDER_ENV_ID }}"
          
          echo "Using Environment ID: $ENVIRONMENT_ID"
          
          # First, check if service with this name already exists
          echo "Checking if service '$SERVICE_NAME' already exists..."
          LIST_RESPONSE=$(curl -s --request GET \
            --url "https://api.render.com/v1/services" \
            --header "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}") \
            --header 'Accept: application/json'
          
          echo "Services list response:"
          echo "$LIST_RESPONSE"
          
          SERVICE_ID=$(echo "$LIST_RESPONSE" | jq -r ".services[] | select(.name == \"$SERVICE_NAME\") | .id" 2>/dev/null | head -1)
          
          if [ -n "$SERVICE_ID" ] && [ "$SERVICE_ID" != "null" ]; then
            echo "Service '$SERVICE_NAME' already exists with ID: $SERVICE_ID"
          else
            echo "Service '$SERVICE_NAME' does not exist, creating new one..."
            SERVICE_RESPONSE=$(curl -v --request POST \
              --url "https://api.render.com/v1/services" \
              --header "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
              --header 'Accept: application/json' \
              --header "Content-Type: application/json" \
              --data '{
                "type": "static_site",
                "name": "'$SERVICE_NAME'",
                "repo": "${{ github.event.pull_request.head.repo.clone_url }}",
                "branch": "${{ github.head_ref }}",
                "publishDirectory": "./dist",
                "autoDeploy": false,
                "environmentId": "'$ENVIRONMENT_ID'",
              }' 2>&1)
            
            echo "Service Response:"
            echo "$SERVICE_RESPONSE"
            SERVICE_ID=$(echo "$SERVICE_RESPONSE" | jq -r '.id' 2>/dev/null)
            echo "Extracted Service ID: $SERVICE_ID"
          fi
          
          if [ -z "$SERVICE_ID" ] || [ "$SERVICE_ID" = "null" ]; then
            echo "ERROR: Failed to get service ID"
            exit 1
          fi
          
          echo "$SERVICE_ID" > service-id.txt
          echo "SERVICE_ID=$SERVICE_ID" >> $GITHUB_OUTPUT

      - name: Upload service ID artifact
        uses: actions/upload-artifact@v4
        with:
          name: service-id
          path: service-id.txt
          
      - name: Post URL to PR comment (placeholder)
        # Add a step to comment the preview URL back to the GitHub Pull Request
        run: echo "Preview service is available at some-url-for-pr-${{ github.event.pull_request.number }}"
          
      - name: Post URL to PR comment (placeholder)
        # Add a step to comment the preview URL back to the GitHub Pull Request
        run: echo "Preview environment is available at some-url-for-pr-${{ github.event.pull_request.number }}"