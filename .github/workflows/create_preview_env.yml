name: Create Render Preview Environment

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Environment
        run: |
          echo "Creating ephemeral environment for PR ${{ github.event.pull_request.number }}"
          ENV_RESPONSE=$(curl --request POST \
            --url "https://api.render.com/v1/projects/${{ secrets.RENDER_PROJECT_ID }}/environments" \
            --header "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            --header "Content-Type: application/json" \
            --data '{
              "name": "pr-${{ github.event.pull_request.number }}-env",
              "description": "Ephemeral environment for PR #${{ github.event.pull_request.number }}"
            }')
          ENVIRONMENT_ID=$(echo "$ENV_RESPONSE" | jq -r '.id')
          echo "Environment ID: $ENVIRONMENT_ID"
          echo "$ENVIRONMENT_ID" > environment-id.txt

      - name: Deploy Service to Environment
        run: |
          echo "Deploying service to environment for PR ${{ github.event.pull_request.number }}"
          ENVIRONMENT_ID=$(cat environment-id.txt)
          DEPLOY_RESPONSE=$(curl --request POST \
            --url "https://api.render.com/v1/services/${{ secrets.RENDER_SERVICE_ID }}/deploys" \
            --header "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            --header "Content-Type: application/json" \
            --data '{
              "environmentId": "'$ENVIRONMENT_ID'"
            }')
          DEPLOY_ID=$(echo "$DEPLOY_RESPONSE" | jq -r '.id')
          echo "Deploy ID: $DEPLOY_ID"
          echo "$DEPLOY_ID" > deploy-id.txt

      - name: Upload environment ID artifact
        uses: actions/upload-artifact@v4
        with:
          name: environment-id
          path: environment-id.txt

      - name: Upload deploy ID artifact
        uses: actions/upload-artifact@v4
        with:
          name: deploy-id
          path: deploy-id.txt
          
      - name: Post URL to PR comment (placeholder)
        # Add a step to comment the preview URL back to the GitHub Pull Request
        run: echo "Preview environment is available at some-url-for-pr-${{ github.event.pull_request.number }}"