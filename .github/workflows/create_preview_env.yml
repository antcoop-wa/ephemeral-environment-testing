name: Create Render Preview Service

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    steps:
      - name: Verify jq is installed
        run: jq --version
        
      - name: Debug network environment
        run: |
          echo "--- proxy env vars ---"
          env | grep -i proxy || true
          echo "--- curl version ---"
          curl --version
        
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create Static Site Service
        run: |
          echo "Creating static site service for PR ${{ github.event.pull_request.number }}"
          SERVICE_NAME="wa-test-pr-${{ github.event.pull_request.number }}-static"
          ENVIRONMENT_ID="${{ vars.RENDER_ENV_ID }}"
          REPO_URL="${{ github.event.pull_request.head.repo.clone_url }}"
          BRANCH_NAME="${{ github.head_ref }}"
          
          # Fail fast with clear message if required secrets are missing
          if [ -z "$ENVIRONMENT_ID" ]; then
            echo "ERROR: RENDER_ENV_ID variable is empty. Please set the variable 'RENDER_ENV_ID' in the repository settings."
            exit 1
          fi
          if [ -z "${{ secrets.RENDER_API_KEY }}" ]; then
            echo "ERROR: RENDER_API_KEY secret is empty. Please set the secret 'RENDER_API_KEY' in the repository settings."
            exit 1
          fi
          
          echo "Using Environment ID: $ENVIRONMENT_ID"
          
          # First, check if service with this name already exists
          echo "Checking if service '$SERVICE_NAME' already exists..."
          LIST_RAW=$(curl -sS --noproxy api.render.com --retry 3 --retry-delay 2 --request GET \
            --url "https://api.render.com/v1/services" \
            --header "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
            --header "Accept: application/json" \
            -w "::HTTP_STATUS::%{http_code}")

          LIST_STATUS=$(echo "$LIST_RAW" | awk -F"::HTTP_STATUS::" '{print $2}')
          LIST_BODY=$(echo "$LIST_RAW" | sed -e 's/::HTTP_STATUS::.*$//')

          echo "Services list HTTP status: $LIST_STATUS"
          echo "Services list body: $LIST_BODY"
          echo "Repo URL being used: $REPO_URL"
          echo "Branch being used: $BRANCH_NAME"

          SERVICE_ID=$(echo "$LIST_BODY" | jq -r ".[] | select(.service.name == \"$SERVICE_NAME\") | [.] | first | .service.id" 2>/dev/null | head -1)
          SERVICE_URL=$(echo "$LIST_BODY" | jq -r ".[] | select(.service.name == \"$SERVICE_NAME\") | [.] | first | .service.serviceDetails.url" 2>/dev/null | head -1)
          
          if [ -n "$SERVICE_ID" ] && [ "$SERVICE_ID" != "null" ]; then
            echo "Service '$SERVICE_NAME' already exists with ID: $SERVICE_ID"
            echo "Service URL: $SERVICE_URL"
          else
            echo "Service '$SERVICE_NAME' does not exist, creating new one..."
            SERVICE_RAW=$(curl -sS --noproxy api.render.com --retry 3 --retry-delay 2 --request POST \
              --url "https://api.render.com/v1/services" \
              --header "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}" \
              --header "Accept: application/json" \
              --header "Content-Type: application/json" \
              --data '{
                "type": "static_site",
                "name": "'$SERVICE_NAME'",
                "repo": "${{ github.event.pull_request.head.repo.clone_url }}",
                "branch": "${{ github.head_ref }}",
                "publishDirectory": "./dist",
                "autoDeploy": "yes",
                "environmentId": "'$ENVIRONMENT_ID'",
                "ownerId": "${{ secrets.RENDER_OWNER_ID }}"
              }' -w "::HTTP_STATUS::%{http_code}")

            SERVICE_STATUS=$(echo "$SERVICE_RAW" | awk -F"::HTTP_STATUS::" '{print $2}')
            SERVICE_BODY=$(echo "$SERVICE_RAW" | sed -e 's/::HTTP_STATUS::.*$//')

            echo "Service create HTTP status: $SERVICE_STATUS"
            echo "Service create body: $SERVICE_BODY"

            SERVICE_ID=$(echo "$SERVICE_BODY" | jq -r '.service.id' 2>/dev/null)
            SERVICE_URL=$(echo "$SERVICE_BODY" | jq -r '.service.serviceDetails.url' 2>/dev/null)
            echo "Extracted Service ID: $SERVICE_ID"
            echo "Extracted Service URL: $SERVICE_URL"
          fi
          
          if [ -z "$SERVICE_ID" ] || [ "$SERVICE_ID" = "null" ]; then
            echo "ERROR: Failed to get service ID"
            exit 1
          fi
          
          echo "$SERVICE_ID" > service-id.txt
          echo "$SERVICE_URL" > service-url.txt
          echo "SERVICE_ID=$SERVICE_ID" >> $GITHUB_OUTPUT
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT

      - name: Upload service ID artifact
        uses: actions/upload-artifact@v4
        with:
          name: service-id
          path: service-id.txt

      - name: Upload service URL artifact
        uses: actions/upload-artifact@v4
        with:
          name: service-url
          path: service-url.txt
          
      - name: Post URL to PR comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let serviceUrl = 'URL not available';
            try {
              if (fs.existsSync('service-url.txt')) {
                serviceUrl = fs.readFileSync('service-url.txt', 'utf8').trim();
              }
            } catch (e) {
              console.log('Could not read service-url.txt:', e.message);
            }
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ðŸš€ Preview environment deployed!\n\n**Service URL:** ${serviceUrl}\n\nThis preview will be cleaned up when the PR is closed.`
            });

      - name: Create PR check with service URL
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let serviceUrl = 'URL not available';
            try {
              if (fs.existsSync('service-url.txt')) {
                serviceUrl = fs.readFileSync('service-url.txt', 'utf8').trim();
              }
            } catch (e) {
              console.log('Could not read service-url.txt:', e.message);
            }
            github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Preview Environment',
              head_sha: context.payload.pull_request.head.sha,
              status: 'completed',
              conclusion: 'success',
              output: {
                title: 'ðŸš€ Preview Deployed',
                summary: `Your preview environment is ready!`,
                text: `**Service URL:** [${serviceUrl}](${serviceUrl})\n\nThis preview will be automatically cleaned up when the PR is closed.`
              }
            });